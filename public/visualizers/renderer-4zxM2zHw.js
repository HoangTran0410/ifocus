import{e as h,d as U,f as p,b as A,i as S,j as X,k as I,l as C,F as L}from"./utils-DsFqD6CR.js";const u=new Map,s=512;function v(t,r){const{ctx:l,canvas:o,data:n,performanceMode:_=!1,bass:g=0,mid:c=0,high:R=0}=t;if(!h(o.width,o.height))return;const D=U(),a=S();if(!a)return;const E=t.mode||"default";let e=u.get(E);if((!e||!e.program)&&(e={program:null,uniforms:{},time:0,audioTexture:null,audioData:null},u.set(E,e)),!e.program){if(e.program=p(a,L,r),!e.program)return;e.uniforms=A(a,e.program)}const m=e.uniforms.u_audioData!=null;if(m&&(e.audioTexture||(e.audioTexture=a.createTexture(),e.audioData=new Uint8Array(s*2*4)),e.audioTexture&&e.audioData)){for(let i=0;i<s;i++){const d=Math.floor(i/s*n.length),T=Math.floor((n[d]||0)*255),f=i*4;e.audioData[f]=T,e.audioData[f+1]=T,e.audioData[f+2]=T,e.audioData[f+3]=255}a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,e.audioTexture),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,s,2,0,a.RGBA,a.UNSIGNED_BYTE,e.audioData),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE)}if(X(),!e.program)return;e.time+=_?.012:.016;const x=n.reduce((i,d)=>i+d,0)/n.length;a.viewport(0,0,a.drawingBufferWidth,a.drawingBufferHeight),a.clearColor(0,0,0,0),a.clear(a.COLOR_BUFFER_BIT),a.useProgram(e.program),a.uniform1f(e.uniforms.u_time,e.time),a.uniform1f(e.uniforms.u_intensity,x),a.uniform1f(e.uniforms.u_bass,g),a.uniform1f(e.uniforms.u_mid,c),a.uniform1f(e.uniforms.u_high,R),a.uniform2f(e.uniforms.u_resolution,o.width,o.height),m&&e.audioTexture&&(a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,e.audioTexture),a.uniform1i(e.uniforms.u_audioData,0)),a.enable(a.BLEND),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),I(e.program),C(D,l,o)}function M(t){if(t===0)u.forEach(r=>{r.program=null,r.uniforms={},r.audioTexture=null,r.audioData=null}),u.clear();else if(typeof t=="string"){const r=u.get(t);if(!r)return;r.program=null,r.uniforms={},r.audioTexture=null,r.audioData=null,u.delete(t)}}export{M as c,v as r};
